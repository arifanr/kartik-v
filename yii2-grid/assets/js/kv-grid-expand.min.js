/*!
 * @package   yii2-grid
 * @author    Kartik Visweswaran <kartikv2@gmail.com>
 * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2014 - 2015
 * @version   3.0.2
 *
 * Client actions for yii2-grid expand row
 * 
 * Author: Kartik Visweswaran
 * Copyright: 2015, Kartik Visweswaran, Krajee.com
 * For more JQuery plugins visit http://plugins.krajee.com
 * For more Yii related demos visit http://demos.krajee.com
 */var kvRowNum=0,kvExpandRow;kvExpandRow=function(e){"use strict";!function(n){var t=e.gridId,a=e.hiddenFromExport,l=e.detailUrl,o=e.onDetailLoaded,d=e.expandIcon,i=e.collapseIcon,s=e.expandTitle,r=e.collapseTitle,c=e.expandAllTitle,v=e.collapseAllTitle,p=e.expandOneOnly,f=e.enableRowClick,k=e.rowClickExcludedTags,u=e.enableCache,x=e.extraData,h=a?e.rowCssClass+" skip-export":e.rowCssClass,g=e.animationDuration,w=n("#"+t),m=w.find(".kv-expand-header-cell.kv-batch-toggle"),C=m.find(".kv-expand-header-icon"),R=void 0===e.collapseAll?!1:e.collapseAll,A=void 0===e.expandAll?!1:e.expandAll,N=w.find("td .kv-expand-row:not(.kv-state-disabled)"),b=N.length,y="kv-expand-detail-loading",T=function(){var e=w.find(".kv-expand-icon:first").closest("tr"),t=0;return e.length?(e=e.clone(),e.find(".kv-expand-row").remove(),e.find("td").each(function(){"none"!==n(this).css("display")&&t++}),t):0},E=T(),D=function(e){return e.hasClass("kv-state-collapsed")&&!e.hasClass("kv-state-disabled")},I=function(e){return e.hasClass("kv-state-expanded")&&!e.hasClass("kv-state-disabled")},F=function(e,n){e.length&&e.removeClass(n).addClass(n)},L=function(e){e.removeClass("kv-state-collapsed").addClass("kv-state-expanded")},O=function(e){e.removeClass("kv-state-expanded").addClass("kv-state-collapsed")},U=function(e){F(e,y)},j=function(e){if(e.length){var n=isNaN(g)?1e3:g+200;setTimeout(function(){e.removeClass(y)},n)}};return 0===x.length&&(x={}),0===N.length?void F(m,"kv-state-disabled"):(N.each(function(){var t,a,c=n(this),v=c.find(".kv-expand-icon"),T=c.closest("tr"),F=c.closest(".kv-expand-icon-cell"),K=c.find(".kv-expand-detail"),Q=c.find(".kv-expanded-row"),q=Q.data("key"),z=Q.data("index");if(!D(v)&&!I(v))return!0;0===Q.length&&(q=T.data("key"),t=T.next('tr.kv-expand-detail-row[data-key="'+q+'"]'),Q=t.find(".kv-expanded-row"));var B=function(e){var t=n.extend({expandRowKey:q,expandRowInd:z},x),a=u?0===Q.html().length:!0;return U(F),l.length>0&&a?(w.trigger("kvexprow.beforeLoad",[z,q,x]),void Q.load(l,t,function(){j(F),o&&n.isFunction(o)&&o(),e(),w.trigger("kvexprow.loaded",[z,q,x])})):(j(F),void e())},G=function(e){w.find('tr[data-index="'+z+'"]').remove(),Q.hide(),T.after(Q);var n='<tr class="kv-expand-detail-row '+h+'" data-key="'+q+'" data-index="'+z+'">';Q.wrap('<td colspan="'+E+'">').parent().wrap(n),v.html(i),F.attr("title",r),e?Q.slideDown(g,function(){O(v)}):(Q.show(),O(v)),0===l.length&&j(F)},H=function(){U(F),K.html(""),v.html(d),F.attr("title",s),a=Q.closest(".kv-expand-detail-row"),Q.slideUp(g,function(){Q.unwrap().unwrap(),Q.appendTo(K),L(v)}),j(F)},J=function(){var t,a,l=!1,o=!1;if(!F.hasClass(y)){if(I(v)){if(a=p&&!R){if(t=n.extend({},e,{collapseAll:!0}),N.each(function(){return n(this).closest(".kv-expand-icon-cell").hasClass(y)?void(o=!0):void 0}),o)return;kvExpandRow(t),l=!0}return B(function(){G(!0)}),void((!a||l)&&(w.trigger("kvexprow.toggle",[z,q,x,!0]),v.focus()))}D(v)&&(H(),w.trigger("kvexprow.toggle",[z,q,x,!1]),v.focus())}};return A?(I(v)&&B(function(){G(!0),kvRowNum++,kvRowNum>=b&&(j(m),C.focus())}),kvRowNum>=b&&(j(m),C.focus()),!0):R?(D(v)&&(H(),kvRowNum++,kvRowNum>=b&&(j(m),C.focus())),kvRowNum>=b&&(j(m),C.focus()),!0):(D(v)&&G(!1),F.off("click").on("click",function(){J(F)}),void T.off("click").on("click",function(e){var t=e.target,a=n(t).length&&n(t).hasClass("kv-disable-click")||-1!==n.inArray(t.nodeName,k);f&&!a&&J(F)}))}),void(m.length&&m.off().on("click",function(){if(!m.hasClass(y)&&0!==N.length){var t=I(C),a=D(C),l=n.extend({},e,{expandAll:a,collapseAll:t});U(m),a?(kvRowNum=N.find(".kv-state-collapsed").length,L(C),C.html(i),m.attr("title",v),w.trigger("kvexprow.toggleAll",[x,!1])):t&&(kvRowNum=N.find(".kv-state-expanded").length,O(C),C.html(d),m.attr("title",c),w.trigger("kvexprow.toggleAll",[x,!0])),kvExpandRow(l)}})))}(window.jQuery)};